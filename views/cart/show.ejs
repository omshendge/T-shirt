<% layout("/layouts/boilerplate") %>
<body>
    <div class="container mt-4">
        <h2>Your Shopping Cart</h2>
        
        <% if (cart.items.length > 0) { %>
            <% cart.items.forEach(item => { %>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <img src="<%= item.product.image %>" class="product-image" alt="<%= item.product.title %>">
                    </div>
                    <div class="col-md-6">
                        <h2><%= item.product.title %></h2>
                        <p class="price">&#8377;<%= item.price.toLocaleString("en-IN") %></p>
                        <p><%= item.product.description %></p>

                        <!-- Size Selection -->
                        <div class="mb-3">
                            <h5>Size: <%= item.size %></h5>
                        </div>

                        <!-- Quantity Selection -->
                        <div class="mb-3">
                            <label class="form-label">Quantity:</label>
                            <input type="number" name="quantity" id="quantity-<%= item.product._id %>" 
                                   min="1" value="<%= item.quantity %>" class="form-control w-50" required>
                        </div>

                        <!-- Remove from Cart -->
                        <form action="/cart/remove/<%= item.product._id %>" method="POST">
                            <input type="hidden" name="size" value="<%= item.size %>">
                            <button type="submit" class="btn btn-danger">Remove</button>
                        </form>

                        <!-- Wishlist Button -->
                        <form action="/wishlist/add" method="POST" class="mt-3">
                            <input type="hidden" name="productId" value="<%= item.product._id %>">
                            <input type="hidden" name="size" value="<%= item.size %>">
                            <button type="submit" class="btn btn-outline-danger btn-lg py-3 shadow-sm rounded-pill">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                    <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                                </svg>
                                Add to Wishlist
                            </button>
                        </form>
                    </div>
                </div>
            <% }) %>

            <hr>
            <!-- Cart Summary -->
            <div class="text-end">
                <h4>Total: â‚¹<%= cart.items.reduce((total, item) => total + item.price * item.quantity, 0) %></h4>
                <button id="rzp-button1" class="btn btn-success btn-lg py-3 shadow-sm rounded-pill">Proceed to Payment</button>
            </div>

        <% } else { %>
            <p>Your cart is empty.</p>
        <% } %>
    </div>

    <!-- Razorpay Payment Script -->
    <script>
        document.getElementById('rzp-button1').onclick = async function(e) {
            e.preventDefault();

            const response = await fetch("/payment/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            const order = await response.json();

            var options = {
                "key": order.key,
                "amount": order.amount * 100,
                "currency": order.currency,
                "name": "WanderLust Store",
                "description": "Complete your purchase",
                "order_id": order.orderId,
                "handler": async function (response) {
                    const verifyRes = await fetch("/payment/verify-payment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(response)
                    });

                    const result = await verifyRes.json();
                    if (result.success) {
                        alert("Payment Successful!");
                        window.location.href = result.redirectUrl;
                    } else {
                        alert("Payment Failed! Please try again.");
                    }
                },
                "theme": {
                    "color": "#3399cc"
                }
            };

            var rzp1 = new Razorpay(options);
            rzp1.open();
        };
    </script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>
